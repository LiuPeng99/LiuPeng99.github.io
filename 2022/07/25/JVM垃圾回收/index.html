

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="">
  <meta name="keywords" content="">
  
    <meta name="description" content="一、对象存活判定算法引用计数法 每个对象都包含一个引用计数器，用于存放引用计数（被引用的次数） 每当有一个地方引用此对象时，引用计数 +1 当引用失效（离开了局部变量的作用域、引用被设定为null）时，引用计数 -1 当引用计数为 0 时，表示此对象不能再被使用，因为没有任何途径可以得到此对象的引用了  虽然这个方法简单高效，但是主流的虚拟机并没有选择这个算法来管理内存，主要原因是它很难解决对象之">
<meta property="og:type" content="article">
<meta property="og:title" content="JVM垃圾回收">
<meta property="og:url" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/index.html">
<meta property="og:site_name">
<meta property="og:description" content="一、对象存活判定算法引用计数法 每个对象都包含一个引用计数器，用于存放引用计数（被引用的次数） 每当有一个地方引用此对象时，引用计数 +1 当引用失效（离开了局部变量的作用域、引用被设定为null）时，引用计数 -1 当引用计数为 0 时，表示此对象不能再被使用，因为没有任何途径可以得到此对象的引用了  虽然这个方法简单高效，但是主流的虚拟机并没有选择这个算法来管理内存，主要原因是它很难解决对象之">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-1.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-2.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-3.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-4.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-5.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-6.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-7.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-8.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-9.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-10.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-11.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-12.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-13.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-14.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-15.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-16.png">
<meta property="og:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-17.png">
<meta property="article:published_time" content="2022-07-25T02:13:26.312Z">
<meta property="article:modified_time" content="2022-07-26T05:20:06.481Z">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://yoursite.com/2022/07/25/JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/JVM垃圾回收/image-1.png">
  
  
  
  <title>JVM垃圾回收 - </title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yoursite.com","root":"/","version":"1.9.3","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"MktjiUfWXW9zem7A0x05gCWO-gzGzoHsz","app_key":"lEDgafWi9K8r0wRObdJ78mOw","server_url":"https://mktjiufw.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":true}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>:)L</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="JVM垃圾回收"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-07-25 10:13" pubdate>
          2022年7月25日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          107 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">JVM垃圾回收</h1>
            
              <p class="note note-info">
                
                  
                    本文最后更新于：2 个月前
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="一、对象存活判定算法"><a href="#一、对象存活判定算法" class="headerlink" title="一、对象存活判定算法"></a>一、对象存活判定算法</h1><h2 id="引用计数法"><a href="#引用计数法" class="headerlink" title="引用计数法"></a>引用计数法</h2><ul>
<li>每个对象都包含一个<strong>引用计数器</strong>，用于存放引用计数（被引用的次数）</li>
<li>每当有一个地方引用此对象时，引用计数 <code>+1</code></li>
<li>当引用失效（离开了局部变量的作用域、引用被设定为null）时，引用计数 <code>-1</code></li>
<li>当引用计数为 <code>0</code> 时，表示此对象不能再被使用，因为没有任何途径可以得到此对象的引用了</li>
</ul>
<p><strong>虽然这个方法简单高效，但是主流的虚拟机并没有选择这个算法来管理内存，主要原因是它很难解决对象之间相互循环引用的问题</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReferenceCountingGc</span> </span>&#123;<br>    Object instance = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ReferenceCountingGc objA = <span class="hljs-keyword">new</span> ReferenceCountingGc();<br>        ReferenceCountingGc objB = <span class="hljs-keyword">new</span> ReferenceCountingGc();<br>        objA.instance = objB;<br>        objB.instance = objA;<br>        objA = <span class="hljs-keyword">null</span>;<br>        objB = <span class="hljs-keyword">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如上述代码所示：除了对象 <code>objA</code> 和 <code>objB</code>相互引用着对方之外，这两个对象之间再无任何引用。但是他们因为互相引用对方，导致他们的引用计数器的值永远都不为 <code>0</code> ，但是实际上此对象已经欸有任何用途了，导致引用计数器无法通知 GC 回收器 回收他们。</p>
<h2 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h2><p>这个算法的基本思想就是通过一系列的称为 <strong>“GC Roots”</strong> 的对象作为起点，从这些节点开始向下搜索，节点所走过的路径称为引用链，当一个对象到 GC Roots 没有任何引用链相连的话，则证明此对象是不可用的，需要被回收。</p>
<p>下图中的 <code>Object 6 ~ Object 10</code> 之间虽有引用关系，但它们到 GC Roots 不可达，因此为需要被回收的对象。</p>
<p><img src="JVM垃圾回收/image-1.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><strong>哪些对象可以作为 GC Roots 呢？</strong></p>
<ul>
<li>虚拟机栈(栈帧中的本地变量表)中引用的对象（其实就是方法中的局部变量）</li>
<li>本地方法栈(Native 方法)中引用的对象</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>所有被同步锁持有的对象</li>
</ul>
<p><img src="JVM垃圾回收/image-2.png" srcset="/img/loading.gif" lazyload alt="image-2"></p>
<p>一旦已经存在的根节点不满足存在的条件时，那么根节点与对象之间的连接将被断开。此时虽然对象1仍存在对其他对象的引用，但是由于其没有任何根节点引用，所以此对象即可被判定为不再使用。比如某个方法中的局部变量引用，在方法执行完成返回之后：</p>
<p><img src="JVM垃圾回收/image-3.png" srcset="/img/loading.gif" lazyload alt="image-3"></p>
<p>这样就<strong>能很好地解决我们刚刚提到的循环引用问题</strong>，我们再来重现一下出现循环引用的情况：</p>
<p><img src="JVM垃圾回收/image-4.png" srcset="/img/loading.gif" lazyload alt="image-4"></p>
<p>可以看到，对象1和对象2依然是存在循环引用的，但是他们各自的GC Roots都断开时，就会变成下面这样：</p>
<p><img src="JVM垃圾回收/image-5.png" srcset="/img/loading.gif" lazyload alt="image-5"></p>
<p>所以，我们最后进行一下总结：如果某个对象无法到达任何GC Roots，则证明此对象是不可能再被使用的。</p>
<p><strong>对象可以被回收，就代表一定会被回收吗？</strong></p>
<p>即使在可达性分析法中不可达的对象，也并非是“非死不可”的，这时候它们暂时处于“缓刑阶段”，要真正宣告一个对象死亡，至少要经历两次标记过程；可达性分析法中不可达的对象被第一次标记并且进行一次筛选，筛选的条件是此对象是否有必要执行 <code>finalize</code> 方法</p>
<p><strong>（只有重写了<code>finalize</code> 方法且未执行过的对象才满足执行条件）</strong>被判定为需要执行的对象将会被放在一个队列中进行第二次标记，除非这个对象与引用链上的任何一个对象建立关联，否则就会被真的回收。</p>
<p>当对象没有覆盖 <code>finalize</code> 方法，或 <code>finalize</code> 方法已经被虚拟机调用过时，虚拟机将这两种情况视为没有必要执行。</p>
<p><img src="JVM垃圾回收/image-6.png" srcset="/img/loading.gif" lazyload alt=""></p>
<blockquote>
<p><code>Object</code> 类中的 <code>finalize</code> 方法一直被认为是一个糟糕的设计，成为了 Java 语言的负担，影响了 Java 语言的安全和 GC 的性能。JDK 9 版本及后续版本中各个类中的 <code>finalize</code> 方法会被逐渐弃用移除。忘掉它的存在吧！</p>
</blockquote>
<h1 id="二、垃圾回收算法"><a href="#二、垃圾回收算法" class="headerlink" title="二、垃圾回收算法"></a>二、垃圾回收算法</h1><h2 id="分代收集机制"><a href="#分代收集机制" class="headerlink" title="分代收集机制"></a>分代收集机制</h2><p>实际上，如果我们对堆中的每一个对象都依次判断是否需要回收，这样的效率其实是很低的，那么有没有更好地回收机制呢？第一步，我们可以对堆中的对象进行分代管理。</p>
<p>比如某些对象，在多次垃圾回收时，都未被判定为可回收对象，我们完全可以将这一部分对象放在一起，并让垃圾收集器减少回收此区域对象的频率，这样就能很好地提高垃圾回收的效率了。</p>
<p>因此，Java虚拟机将堆内存划分为<strong>新生代</strong>、<strong>老年代</strong>和<code>永久代</code>（其中永久代是HotSpot虚拟机特有的概念，在JDK8之前方法区实际上就是采用的永久代作为实现，而在JDK8之后，方法区由元空间实现，并且使用的是本地内存，容量大小取决于物理机实际大小，之后会详细介绍）这里我们主要讨论的是新生代和老年代。</p>
<p>不同的分代内存回收机制也存在一些不同之处，在HotSpot虚拟机中，新生代被划分为三块，一块较大的Eden空间和两块较小的Survivor空间，默认比例为8：1：1，老年代的GC评率相对较低，永久代一般存放类信息等（其实就是方法区的实现）如图所示：</p>
<p><img src="JVM垃圾回收/image-7.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li><p>新生代：</p>
<ul>
<li><p>Eden用来分配新对象，满了时会触发Minor GC。</p>
</li>
<li><p>From Survivor是上次Minor GC后存活的对象。</p>
</li>
<li><p>To Survivor是用于下次Minor GC时存放存活的对象。</p>
</li>
</ul>
</li>
<li><p>老年代：</p>
<ul>
<li>用于存放存活时间比较长的对象，大的对象，当容量满时会触发Major GC（Full GC）</li>
</ul>
</li>
</ul>
<p><strong>针对 HotSpot VM 的实现，它里面的 GC 其实准确分类只有两大种：</strong></p>
<ul>
<li><p>部分收集 (Partial GC)：</p>
<ul>
<li><p>新生代收集（Minor GC / Young GC）：只对新生代进行垃圾收集；</p>
<ul>
<li>触发条件：新生代的Eden区内容已满时</li>
</ul>
</li>
<li><p>老年代收集（Major GC / Old GC）：只对老年代进行垃圾收集。需要注意的是 Major GC 在有的语境中也用于指代整堆收集；</p>
</li>
<li><p>混合收集（Mixed GC）：对整个新生代和部分老年代进行垃圾收集。</p>
</li>
</ul>
</li>
<li><p>整堆收集 (Full GC)：</p>
<ul>
<li>收集整个 Java 堆和方法区。<ul>
<li>触发条件1：每次晋升到老年代的对象平均大小 超过 老年代剩余空间</li>
<li>触发条件2：Minor GC 后存活的对象 超过 老年代剩余空间</li>
<li>触发条件3：永久代内存不足（JDK 8 之前）</li>
<li>触发条件4：手动调用 <code>System.gc()</code> 方法</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="空间分配担保机制"><a href="#空间分配担保机制" class="headerlink" title="空间分配担保机制"></a>空间分配担保机制</h2><p>空间分配担保是为了确保在 Minor GC 之前老年代本身还有容纳新生代所有对象的剩余空间</p>
<p>我们可以思考一下，有没有这样一种极端情况（正常情况下新生代的回收率是很高的，所以说不用太担心会经常出现这种问题），在一次GC后，新生代Eden区仍然存在大量的对象（因为GC之后存活对象会进入到一个Survivor区，但是很明显这时已经超出Survivor区的容量了，肯定是装不下的）那么现在该怎么办？</p>
<p>这时就需要用到空间分配担保机制了，可以把Survivor区无法容纳的对象直接送到老年代，让老年代进行分配担保（当然老年代也得装得下才行）在现实生活中，贷款会指定担保人，就是当借款人还不起钱的时候由担保人来还钱。</p>
<p>当新生代无法容纳更多的的对象时，可以把新生代中的对象移动到老年代中，这样新生代就腾出了空间来容纳更多的对象。</p>
<p>那既然新生代装不下就丢给老年代，那如果老年代也装不下新生代的数据呢？这时，老年代肯定担保人是当不成了，那么这样的话，首先会判断一下当前老年代的剩余空间 <code>是否大于</code> 之前的每次垃圾回收进入老年代的平均大小，如果大于，那么说明也许可以放得下（不过也仅仅是也许，依然有可能放不下，因为判断的实际上只是平均值，万一这一次对象突然非常大呢），否则，会先来一次Full GC，进行一次大规模垃圾回收，来尝试腾出空间，再次判断老年代是否有空间存放，如果还是装不下，直接抛出OOM错误，摆烂。<br><img src="JVM垃圾回收/image-8.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h2 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h2><p><strong>一般用于老年代</strong></p>
<p><code>标记-清除</code>算法是最早且最简单的一种垃圾回收算法，在整个垃圾回收过程中总共分为两步：</p>
<ol>
<li>标记需要回收的对象</li>
<li>将第一步标记的对象进行统一的回收</li>
</ol>
<p><img src="JVM垃圾回收/image-9.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>标记-清除算法存在以下问题：</p>
<ol>
<li><p><strong>效率不稳定</strong></p>
<p>如果Java堆中包含有大量的需要回收的对象，那么使用该回收算法的时候就需要去标记大量的对象，然后再去对标记的对象进行回收，导致该回收算法的效率会随着对象数量的增长而降低。</p>
</li>
<li><p><strong>内存碎片化</strong></p>
<p>通过上图可以看到，当完成对象回收之后，未使用的内存区域呈现无规律的随机分布，这就造成了内存碎片化的问题，如果当前Java程序中需要实例化一个大对象，但是由于内存碎片化的问题导致无法分配一个连续的大内存空间，就会导致提前又触发一次垃圾回收。</p>
</li>
</ol>
<p><strong>使用标记-清除算法的垃圾收集器：CMS 垃圾收集器</strong></p>
<blockquote>
<p>标记清除算法常被使用在老年代中，因为老年代中的对象大部分都不会被清理掉，只存在于少部分的对象会被清理，所以在老年代中不会存在标记大量对象并清除的情况。</p>
</blockquote>
<h2 id="标记-复制算法"><a href="#标记-复制算法" class="headerlink" title="标记-复制算法"></a>标记-复制算法</h2><p><strong>一般用于新生代</strong></p>
<p><code>标记-复制</code>算法是在标记-清除的基础上提出的。标记复制算法中将内存区域划分为两块大小一致的区域，每次只使用其中一块，当这一块的内存用完了之后就将还存活的对象复制到另一块区域上去，然后将当前块的内存空间一次性清理掉，假设内存分为A和B两块，首先使用A内存，B作为保留，则标记复制算法步骤如下：</p>
<ol>
<li>在A中标记需要回收的对象</li>
<li>将A中存活的对象复制到B中</li>
<li>将A的内存空间一次性全部清理掉</li>
</ol>
<p><img src="JVM垃圾回收/image-10.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>标记-复制算法存在以下问题：</p>
<ol>
<li>将原有的内存区域划分为两块，且每次只能使用其中一块，则可使用内存相比标记-清除算法缩小了50%，空间浪费太大</li>
<li>如果内存中存活的对象太多，在复制过程中需要复制大量的存活对象，会导致效率低下、额外开销大</li>
</ol>
<p><strong>使用标记-复制算法的垃圾收集器：Serial New，Parallel New，Parallel Scanvage 垃圾收集器</strong></p>
<blockquote>
<p>标记-复制算法适用于Java堆中的新生代部分的垃圾回收，因为在新生代区域中，正常情况下能够存活下来的对象只有极少数，这样复制算法就不存在大量复制对象的情况</p>
<p>针对于空间浪费问题，将新生代区域划分为一块较大的Eden区域和两块较小的Survivor区域，每次分配对象时使用Eden和其中一块Survivor，当发生垃圾回收时，将Eden中和Survivor中存活的对象复制到另一块Survivor中，然后将Eden和已使用过的Survivor内存空间直接清理掉，下一轮分配对象时使用Eden和之前保存了存活对象的那一块Survivor，依次循环</p>
<p>HotSpot虚拟机默认的Eden和Survivor的大小比例为8:1，Eden占新生代80%，两个Survivor各占10%，这样每次可使用的内存空间就是90%，比标记复制算法默认的等分50%要多得多。</p>
</blockquote>
<h2 id="标记-整理算法"><a href="#标记-整理算法" class="headerlink" title="标记-整理算法"></a>标记-整理算法</h2><p><strong>一般用于老年代</strong></p>
<p><code>标记-整理</code>算法又是在标记-清除和标记-复制两种算法的基础上提出的<strong>（为了解决：在老年代中大部分对象都会存活下来，所以不适合标记复制算法，而且使用标记清除算法又会造成大量内存碎片）</strong>。标记整理算法的标记步骤和标记清除算法一致，但是在标记之后不会直接进行清除，而是首先将存活的对象向内存空间的一端进行移动，将所有存活的对象都连续的放在一起，然后直接清理掉边界以外的内存，标记整理算法步骤如下：</p>
<ol>
<li>标记需要回收的对象</li>
<li>将存活的对象向内存空间的一端移动</li>
<li>直接清理掉边界以外的内存</li>
</ol>
<p><img src="JVM垃圾回收/image-11.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>标记-整理算法存在以下问题：</p>
<ol>
<li>由于需要移动对象，停顿时间会比较长，垃圾回收时的延迟会高一些。甚至，由于需要修改对象在内存中的位置，此时程序必须要暂停才可以，在极端情况下，可能会导致整个程序发生停顿（被称为“Stop The World”）。</li>
</ol>
<p><strong>使用标记-复制算法的垃圾收集器：Parallel Old，Serial Old 垃圾收集器</strong></p>
<h1 id="三、垃圾收集器"><a href="#三、垃圾收集器" class="headerlink" title="三、垃圾收集器"></a>三、垃圾收集器</h1><h2 id="Serial-收集器"><a href="#Serial-收集器" class="headerlink" title="Serial 收集器"></a>Serial 收集器</h2><p>Serial（串行）收集器是最基本、最悠久的垃圾收集器。是一个单线程收集器，它的单线程“<strong>单线程</strong>”的意义并不仅仅是只会使用一条垃圾收集线程区完成垃圾收集工作，更重要的是它在进行垃圾收集工作的时候必须暂停其他所有的工作线程（ <strong>“Stop The World”</strong> ），直到它收集结束。<strong>新生代采用标记-复制算法，老年代采用标记-整理算法。</strong></p>
<p><img src="JVM垃圾回收/image-12.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>Serial 收集器的优点：</p>
<ol>
<li>简单且高效（与其他收集器的单线程相比）</li>
<li>没有线程交互的开销，自然可以获得很高的单线程收集效率。在Client模式下（一般用于一些桌面级图形化界面应用程序）的新生代中，默认的垃圾收集器就是Serial收集器</li>
</ol>
<h2 id="Serial-Old-收集器"><a href="#Serial-Old-收集器" class="headerlink" title="Serial Old 收集器"></a>Serial Old 收集器</h2><p><strong>Serial 收集器的老年代版本</strong>，它同样是一个单线程收集器。</p>
<p>它主要有两大用途：</p>
<ol>
<li>在 JDK1.5 及以前的版本中与 Parallel Scavenge 收集器搭配使用</li>
<li>作为 CMS 收集器的后备方案</li>
</ol>
<h2 id="ParNew-收集器"><a href="#ParNew-收集器" class="headerlink" title="ParNew 收集器"></a>ParNew 收集器</h2><p>ParNew 收集器其实就是 Serial 收集器的多线程版本，除了使用多线程进行垃圾收集之外，其余行为（控制参数、收集算法、回收策略等）和 Serial 收集器完全一样。<strong>新生代采用标记-复制算法，老年代采用标记-整理算法。</strong></p>
<p><img src="JVM垃圾回收/image-13.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>ParNew 收集器的优点：</p>
<ol>
<li>是许多运行在Server模式下的虚拟机的首要选择</li>
<li>除了Serial收集器外，只有它能与CMS收集器配合工作</li>
</ol>
<h2 id="Parallel-Scavenge-Parallel-Old-收集器"><a href="#Parallel-Scavenge-Parallel-Old-收集器" class="headerlink" title="Parallel Scavenge / Parallel Old 收集器"></a>Parallel Scavenge / Parallel Old 收集器</h2><p><strong>Parallel Scavenge是一个面向新生代的垃圾收集器，采用标记-复制算法，多线程收集器</strong></p>
<p>关注点是吞吐量（高效率的利用CPU），所谓吞吐量就是CPU用于运行用户代码的时间与CPU总消耗时间的比值。而CMS 等垃圾收集器的关注点更多的是压缩用户线程的停顿时间（提高用户体验）</p>
<p>它会自动衡量一个吞吐量，并根据吞吐量来决定每次垃圾回收的时间，这种自适应机制，能够很好地权衡当前机器的性能，根据性能选择最优方案。</p>
<p><strong>Parallel Old是一个面向老年代的垃圾收集器，采用标记-整理算法，多线程收集器</strong></p>
<blockquote>
<p>在注重吞吐量以及 CPU 资源的场合，都可以优先考虑 Parallel Scavenge 收集器和 Parallel Old 收集器</p>
<p>目前 JDK 8 采用的就是这种 Parallel Scavenge + Parallel Old 的垃圾回收方案。</p>
</blockquote>
<p><img src="JVM垃圾回收/image-14.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h2 id="CMS-收集器"><a href="#CMS-收集器" class="headerlink" title="CMS 收集器"></a>CMS 收集器</h2><p><strong>CMS（Concurrent Mark Sweep）收集器是一种以获取最短回收停顿时间为目标的收集器，它非常注重压缩用户线程的停顿时间（提高用户体验）是 HotSpot 虚拟机第一款真正意义上的并发收集器，它第一次实现了让垃圾收集线程与用户线程（基本上）同时工作</strong></p>
<p>从名字中的<strong>Mark Sweep</strong>这两个词可以看出，CMS 收集器是一种 <strong>“标记-清除”算法</strong>实现的，它的运作过程相比于前面几种垃圾收集器来说更加复杂一些。整个过程分为四个步骤：</p>
<ol>
<li><strong>初始标记：</strong>暂停用户线程，标记出直接与 GC Roots 相连的对象，速度很快；</li>
<li><strong>并发标记：</strong>从 GC Roots 直接相连的对象开始遍历整个对象图的过程，耗时较长，但不需要暂停用户线程，可以与 GC 线程并发运行；</li>
<li><strong>重新标记：</strong>暂停用户线程，修正并发标记期间因为用户线程继续运行而导致标记产生变动的那一部分对象的标记记录，暂停时间比初始标记阶段长一点；</li>
<li><strong>并发清除：</strong>直接将所有标记好的无用的对象进行删除，因为这些对象在程序中用不到了，可以与用户线程并发运行</li>
</ol>
<p><img src="" srcset="/img/loading.gif" lazyload alt=""><img src="JVM垃圾回收/image-15.png" srcset="/img/loading.gif" lazyload alt="image-15"></p>
<p>优点：</p>
<ol>
<li>并发收集</li>
<li>低停顿</li>
</ol>
<p>缺点：</p>
<ol>
<li>对CPU资源敏感</li>
<li>无法处理浮动数据</li>
<li>使用“标记-清除”算法会产生大量的空间碎片</li>
</ol>
<h2 id="G1-收集器"><a href="#G1-收集器" class="headerlink" title="G1 收集器"></a>G1 收集器</h2><p><strong>G1 (Garbage-First)是一款面向服务器的垃圾收集器，主要针对配备多颗处理器及大容量内存的机器，以极高概率满足 GC 停顿时间要求的同时，还具备高吞吐量性能特征</strong></p>
<p>在 JDK 7 时走上历史舞台，并在 JDK 9 时正式取代了 JDK 8 默认的 Parallel Scavenge + Parallel Old 的垃圾回收方案</p>
<p>我们知道，我们的垃圾回收分为<code>Minor GC</code>、<code>Major GC</code>和<code>Full GC</code>，它们分别对应的是新生代，老年代和整个堆内存的垃圾回收，而G1收集器巧妙地绕过了这些约定，它将整个Java堆划分成<code>2048</code>个大小相同的独立<code>Region块</code>，每个<code>Region块</code>的大小根据堆空间的实际大小而定，整体被控制在1MB到32MB之间，且都为2的N次幂。所有的<code>Region块</code>大小相同，且在JVM的整个生命周期内不会发生改变。</p>
<p>那么分出这些<code>Region</code>有什么意义呢？每一个<code>Region</code>都可以根据需要，自由决定扮演哪个角色（Eden、Survivor和老年代），收集器会根据对应的角色采用不同的回收策略。此外，G1收集器还存在一个Humongous区域，它专门用于存放大对象（一般认为大小超过了Region容量一半的对象为大对象）这样，新生代、老年代在物理上，不再是一个连续的内存区域，而是到处分布的。<br><img src="JVM垃圾回收/image-16.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p>它的回收过程与CMS大体类似：</p>
<ol>
<li><strong>初始标记：</strong>暂停用户线程，标记与 GC Roots直接相连的对象，并修改TAMS指针的值，让下一阶段你用户线程并发运行时能够正确的在可用的Region中分配新对象。虽然要暂停用户线程，但耗时很短，并且是在进行Minor GC的时候同步完成，所以G1收集器在这个阶段实际并没有额外的停顿；</li>
<li><strong>并发标记：</strong>从GC Roots开始对堆中的对象进行可达性分析，递归扫描整个堆中的对象图，找出要回收的对象，这个阶段耗时较长，但可与用户线程并发执行；</li>
<li><strong>最终标记：</strong>暂停用户线程，用户处理并发标记阶段漏标的那部分对象；</li>
<li><strong>筛选回收：</strong>负责更新Region的统计数据，对各个Region的回收价值和成本进行排序，根据用户所期望的停顿时间来指定回收计划，可以自由选择任意多个Region构成回收集，然后把决定回收的那一部分Region的存活对象复制到空的Region中，再清理掉整个旧Region的全部空间。这里的操作涉及到存活对象的移动，所以必须暂停用户线程，由多个收集器线程并行完成的</li>
</ol>
<p><img src="JVM垃圾回收/image-17.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h1 id="四、引用类型"><a href="#四、引用类型" class="headerlink" title="四、引用类型"></a>四、引用类型</h1><h2 id="强引用"><a href="#强引用" class="headerlink" title="强引用"></a>强引用</h2><p>在Java中，如果变量是一个对象类型的，那么它实际上存放的是对象的引用，但如果是一个基本类型，那么存放的就是基本类型的值。实际上我们平时代码中类似于 <code>Object o = new Object()</code>这样的引用类型，细分之后就是 <code>强引用</code></p>
<p>如果方法中存在这样的 <code>强引用</code> 类型，当需要回收强引用所执行的对象时，要么此方法运行结束，要么引用连接断开，否则被引用的对象时无法被判定为可回收的。</p>
<p>所以，当 JVM 内存不足时，宁愿抛出 OOM 使程序异常终止，也不会随意回收具有强引用的“存活”对象。</p>
<h2 id="软引用"><a href="#软引用" class="headerlink" title="软引用"></a>软引用</h2><p>当 JVM 内存空间足够时，软引用的对象不会被系统回收。当内存空间不足时，软引用的对象才有可能被系统回收。通常用于内存敏感的程序中。</p>
<p>我们可以通过以下方式来创建一个软引用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-comment">//强引用写法：Object obj = new Object();</span><br>        <span class="hljs-comment">//软引用写法：</span><br>        SoftReference&lt;Object&gt; reference = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> Object());<br>        <span class="hljs-comment">//使用get方法就可以获取到软引用所指向的对象了</span><br>        System.out.println(reference.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到软引用还存在一个带队列的构造方法，软引用可以和一个引用队列（ReferenceQueue）联合使用，如果软引用所引用的对象被垃圾回收器回收，Java虚拟机就会把这个软引用加入到与之关联的引用队列中。</p>
<p>这里我们来进行一个测试，首先我们需要设定一下参数，来限制最大堆内存为10M，并且打印GC日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">-XX:+PrintGCDetails -Xms10M -Xmx10M<br></code></pre></td></tr></table></figure>
<p>接着运行以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        ReferenceQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;&gt;();<br>        SoftReference&lt;Object&gt; reference = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> Object(), queue);<br>        System.out.println(reference);<br><br>        <span class="hljs-keyword">try</span>&#123;<br>            List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) list.add(<span class="hljs-keyword">new</span> String(<span class="hljs-string">&quot;lbwnb&quot;</span>));<br>        &#125;<span class="hljs-keyword">catch</span> (Throwable t)&#123;<br>            System.out.println(<span class="hljs-string">&quot;发生了内存溢出！&quot;</span>+t.getMessage());<br>            System.out.println(<span class="hljs-string">&quot;软引用对象：&quot;</span>+reference.get());<br>            System.out.println(queue.poll());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">ref</span><span class="hljs-operator">.</span><span class="hljs-variable">SoftReference</span><span class="hljs-operator">@</span><span class="hljs-number">232204</span><span class="hljs-variable">a1</span><br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">3943</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">501</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">3943</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2362</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0050615</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">3714</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">496</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">5574</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4829</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0049642</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">3318</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">7652</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">7711</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0059440</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-operator">--</span><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">11807</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">15870</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0078912</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">11262</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">10104</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">11264</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">15870</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">10104</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0587856</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.24</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">4096</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">1535</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">10104</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">11242</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">11264</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">14200</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">12777</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0608198</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.25</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">3965</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3896</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">11242</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">11242</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">11264</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">15207</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">15138</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0972088</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.58</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.10</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">3896</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3896</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">11242</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">11225</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">11264</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">15138</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">15121</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">15872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">3207</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.1028222</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.63</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.10</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>发生了内存溢出！<span class="hljs-variable">Java</span> <span class="hljs-variable">heap</span> <span class="hljs-variable">space</span><br>软引用对象：<span class="hljs-variable">null</span><br><span class="hljs-variable">java</span><span class="hljs-operator">.</span><span class="hljs-variable">lang</span><span class="hljs-operator">.</span><span class="hljs-variable">ref</span><span class="hljs-operator">.</span><span class="hljs-variable">SoftReference</span><span class="hljs-operator">@</span><span class="hljs-number">232204</span><span class="hljs-variable">a1</span><br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">4608</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">4048</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bfb00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">4096</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">98</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bfb00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bfef40a8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bff00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bff00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bff80000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bff80000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">11264</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">11225</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bf000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007bfb00000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007bfb00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">11264</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">99</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bf000000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bfaf64a8</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bfb00000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">3216</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4500</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">352</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">388</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br><br></code></pre></td></tr></table></figure>
<p>可以看到，当内存不足时，软引用所指向的对象被回收了，所以<code>get()</code>方法得到的结果为null，并且软引用对象本身被丢进了队列中。</p>
<h2 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h2><p>弱引用的级别比软引用还低，在进行垃圾回收时，不管当前内存空间是否充足，都会回收它的内存。</p>
<p>我们可以像这样创建一个弱引用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        WeakReference&lt;Object&gt; reference = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(<span class="hljs-keyword">new</span> Object());<br>        System.out.println(reference.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>使用方法和软引用是差不多的，但是如果我们在这之前手动进行一次GC：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        SoftReference&lt;Object&gt; softReference = <span class="hljs-keyword">new</span> SoftReference&lt;&gt;(<span class="hljs-keyword">new</span> Object());<br>        WeakReference&lt;Object&gt; weakReference = <span class="hljs-keyword">new</span> WeakReference&lt;&gt;(<span class="hljs-keyword">new</span> Object());<br><br>        <span class="hljs-comment">//手动GC</span><br>        System.gc();<br><br>        System.out.println(<span class="hljs-string">&quot;软引用对象：&quot;</span>+softReference.get());<br>        System.out.println(<span class="hljs-string">&quot;弱引用对象：&quot;</span>+weakReference.get());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到，弱引用对象直接就被回收了，而软引用对象没有被回收。同样的，它也支持ReferenceQueue，和软引用用法一致，这里就不多做介绍了。</p>
<p><code>WeakHashMap</code>正是一种类似于弱引用的HashMap类，如果Map中的Key没有其他引用那么此Map会自动丢弃此键值对。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Main</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Integer a = <span class="hljs-keyword">new</span> Integer(<span class="hljs-number">1</span>);<br><br>        WeakHashMap&lt;Integer, String&gt; weakHashMap = <span class="hljs-keyword">new</span> WeakHashMap&lt;&gt;();<br>        weakHashMap.put(a, <span class="hljs-string">&quot;yyds&quot;</span>);<br>        System.out.println(weakHashMap);<br><br>        a = <span class="hljs-keyword">null</span>;<br>        System.gc();<br>        <br>        System.out.println(weakHashMap);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>可以看到，当变量a的引用断开后，这时只有WeakHashMap本身对此对象存在引用，所以在GC之后，这个键值对就自动被舍弃了。所以说这玩意，就挺适合拿去做缓存的。</p>
<h2 id="虚引用（鬼引用）"><a href="#虚引用（鬼引用）" class="headerlink" title="虚引用（鬼引用）"></a>虚引用（鬼引用）</h2><p>虚引用相当于没有引用，随时都有可能会被回收。</p>
<p>看看它的源码，非常简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhantomReference</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Reference</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns this reference object&#x27;s referent.  Because the referent of a</span><br><span class="hljs-comment">     * phantom reference is always inaccessible, this method always returns</span><br><span class="hljs-comment">     * &lt;code&gt;null&lt;/code&gt;.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>  &lt;code&gt;null&lt;/code&gt;</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Creates a new phantom reference that refers to the given object and</span><br><span class="hljs-comment">     * is registered with the given queue.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * &lt;p&gt; It is possible to create a phantom reference with a &lt;tt&gt;null&lt;/tt&gt;</span><br><span class="hljs-comment">     * queue, but such a reference is completely useless: Its &lt;tt&gt;get&lt;/tt&gt;</span><br><span class="hljs-comment">     * method will always return null and, since it does not have a queue, it</span><br><span class="hljs-comment">     * will never be enqueued.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> referent the object the new phantom reference will refer to</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> q the queue with which the reference is to be registered,</span><br><span class="hljs-comment">     *          or &lt;tt&gt;null&lt;/tt&gt; if registration is not required</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">PhantomReference</span><span class="hljs-params">(T referent, ReferenceQueue&lt;? <span class="hljs-keyword">super</span> T&gt; q)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(referent, q);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>也就是说我们无论调用多少此<code>get()</code>方法得到的永远都是<code>null</code>，因为虚引用本身就不算是个引用，相当于这个对象不存在任何引用，并且只能使用带队列的构造方法，主要用于跟踪对象被垃圾回收的状态，以便对象被回收时可以接到通知。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>JVM垃圾回收</div>
      <div>http://yoursite.com/2022/07/25/JVM垃圾回收/</div>
    </div>
    <div class="license-meta">
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年7月25日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/07/26/%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" title="类文件结构与类加载机制">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">类文件结构与类加载机制</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/23/JVM%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/" title="JVM内存区域">
                        <span class="hidden-mobile">JVM内存区域</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  









    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  
      <script>
        if (!window.MathJax) {
          window.MathJax = {
            tex    : {
              inlineMath: { '[+]': [['$', '$']] }
            },
            loader : {
              load: ['ui/lazy']
            },
            options: {
              renderActions: {
                insertedScript: [200, () => {
                  document.querySelectorAll('mjx-container').forEach(node => {
                    let target = node.parentNode;
                    if (target.nodeName.toLowerCase() === 'li') {
                      target.parentNode.classList.add('has-jax');
                    }
                  });
                }, '', false]
              }
            }
          };
        } else {
          MathJax.startup.document.state(0);
          MathJax.texReset();
          MathJax.typeset();
          MathJax.typesetPromise();
        }

        Fluid.events.registerRefreshCallback(function() {
          if ('MathJax' in window && MathJax.startup.document && typeof MathJax.startup.document.state === 'function') {
            MathJax.startup.document.state(0);
            MathJax.texReset();
            MathJax.typeset();
            MathJax.typesetPromise();
          }
        });
      </script>
    

  <script  src="https://lib.baomitu.com/mathjax/3.2.2/es5/tex-mml-chtml.js" ></script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
